---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

// Get token from URL
const token = Astro.url.searchParams.get('token');
---

<Layout title="Verify Email - Illoominate">
  <Header />
  <main class="pt-24 min-h-screen bg-gradient-hero">
    <div class="max-w-lg mx-auto px-4 py-16">
      <div id="verify-container" class="bg-white rounded-2xl shadow-xl p-8 text-center">
        {!token ? (
          <>
            <div class="w-16 h-16 mx-auto mb-6 rounded-full bg-red-100 flex items-center justify-center">
              <svg class="w-8 h-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </div>
            <h1 class="text-2xl font-bold text-slate-900 mb-4">Invalid Link</h1>
            <p class="text-slate-600 mb-6">
              This verification link is invalid or has already been used.
            </p>
            <a href="/" class="btn-primary">Return Home</a>
          </>
        ) : (
          <>
            <div id="loading-state">
              <div class="w-16 h-16 mx-auto mb-6 rounded-full bg-indigo-100 flex items-center justify-center">
                <svg class="w-8 h-8 text-indigo-600 animate-spin" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                </svg>
              </div>
              <h1 class="text-2xl font-bold text-slate-900 mb-4">Verifying your email...</h1>
              <p class="text-slate-600">Just a moment while we confirm your email address.</p>
            </div>

            <div id="success-state" class="hidden">
              <div class="w-16 h-16 mx-auto mb-6 rounded-full bg-emerald-100 flex items-center justify-center">
                <svg class="w-8 h-8 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <h1 class="text-2xl font-bold text-slate-900 mb-4">Email Verified!</h1>
              <p class="text-slate-600 mb-6" id="success-message">
                Your spot on the waitlist is confirmed.
              </p>
              <div class="bg-slate-50 rounded-xl p-4 mb-6 text-left">
                <p class="text-sm text-slate-600 mb-2">Your position:</p>
                <p class="text-3xl font-bold text-indigo-600" id="position-number">#--</p>
                <p class="text-sm text-slate-500 mt-1" id="invite-code-display">Invite code: --</p>
              </div>
              <p class="text-sm text-slate-600 mb-6">
                Share your invite code to move up the list. Each verified referral bumps you higher!
              </p>
              <a href="/" class="btn-primary">Return Home</a>
            </div>

            <div id="error-state" class="hidden">
              <div class="w-16 h-16 mx-auto mb-6 rounded-full bg-red-100 flex items-center justify-center">
                <svg class="w-8 h-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
              </div>
              <h1 class="text-2xl font-bold text-slate-900 mb-4">Verification Failed</h1>
              <p class="text-slate-600 mb-6" id="error-message">
                Something went wrong. Please try again.
              </p>
              <a href="/" class="btn-primary">Return Home</a>
            </div>
          </>
        )}
      </div>
    </div>
  </main>
  <Footer />
</Layout>

{token && (
  <script define:vars={{ token }}>
    async function verifyEmail() {
      const loadingState = document.getElementById('loading-state');
      const successState = document.getElementById('success-state');
      const errorState = document.getElementById('error-state');
      const errorMessage = document.getElementById('error-message');
      const positionNumber = document.getElementById('position-number');
      const inviteCodeDisplay = document.getElementById('invite-code-display');

      try {
        const response = await fetch(`/api/verify?token=${encodeURIComponent(token)}`, {
          method: 'GET',
        });

        const data = await response.json();

        if (response.ok) {
          loadingState.classList.add('hidden');
          successState.classList.remove('hidden');
          if (data.position) {
            positionNumber.textContent = `#${data.position}`;
          }
          if (data.invite_code) {
            inviteCodeDisplay.textContent = `Invite code: ${data.invite_code}`;
          }
        } else {
          loadingState.classList.add('hidden');
          errorState.classList.remove('hidden');
          errorMessage.textContent = data.error || 'Verification failed. The link may have expired.';
        }
      } catch (err) {
        loadingState.classList.add('hidden');
        errorState.classList.remove('hidden');
        errorMessage.textContent = 'Unable to verify. Please try again later.';
      }
    }

    verifyEmail();
  </script>
)}
